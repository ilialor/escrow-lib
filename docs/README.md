# Документация по Escrow Library

## Введение

Escrow Library - это модульная библиотека, предназначенная для управления условными депозитами (escrow) в групповых заказах с интегрированной системой документооборота, коммуникации и AI-поддержки. Она обеспечивает безопасное хранение средств, поэтапные выплаты и эффективную коммуникацию между участниками проекта.

## Основные компоненты документации

- [Управление пользователями](users.md) - создание и управление учетными записями пользователей
- [Управление заказами](orders.md) - создание и управление заказами и вехами
- [Групповые заказы](group-orders.md) - работа с групповыми заказами
- [Документы](documents.md) - хранение и управление документами
- [Документооборот с AI](document-management.md) - автоматизация работы с документами с использованием AI
- [Коммуникация](communication.md) - обсуждения и обмен сообщениями
- [События](events.md) - система событий и подписок

## Установка

```bash
npm install escrow-lib
```

## Быстрый старт

```typescript
import { EscrowManager, UserType } from 'escrow-lib';

// Инициализация менеджера с поддержкой AI
const escrowManager = new EscrowManager('ваш-gemini-api-ключ');

// Создание пользователей
const customer = await escrowManager.createUser('Иван', UserType.CUSTOMER);
const contractor = await escrowManager.createUser('Сергей', UserType.CONTRACTOR);

// Создание заказа с вехами
const order = await escrowManager.createOrder(
  customer.id,
  'Разработка сайта',
  'Создание корпоративного сайта',
  [
    { description: 'Дизайн', amount: '300', deadline: new Date('2023-12-15') },
    { description: 'Верстка', amount: '300', deadline: new Date('2023-12-31') },
    { description: 'Программирование', amount: '400', deadline: new Date('2024-01-31') }
  ]
);

// Генерация документов с использованием AI
const dor = await escrowManager.generateDoR(order.id);
const roadmap = await escrowManager.generateRoadmap(order.id);
const dod = await escrowManager.generateDoD(order.id);
```

## Основные возможности

### Управление пользователями

Библиотека поддерживает три типа пользователей:
- **Заказчик (Customer)**: создает заказы и вносит средства на эскроу-счета. Может быть как индивидуальным заказчиком, так и участником группового заказа.
- **Исполнитель (Contractor)**: выполняет работы по заказам и получает оплату после подтверждения выполнения работ.
- **Платформа (Platform)**: выступает арбитром, взимает комиссию и обладает административными функциями для разрешения споров.

Модуль управления пользователями позволяет:
- Создавать пользователей различных типов
- Управлять учетными данными и профилями
- Пополнять балансы пользователей
- Проверять авторизацию и права доступа

### Заказы и вехи

Модуль управления заказами предоставляет функции для:
- Создания заказов с детальным описанием работ
- Разделения заказов на вехи (milestones) с отдельными бюджетами и сроками
- Назначения исполнителей на заказы
- Отслеживания прогресса по каждой вехе
- Контроля статусов заказов и вех (создан, в работе, завершен, отменен)

Заказы содержат одну или несколько вех (milestones), каждая со своим бюджетом и описанием работ. Средства хранятся на эскроу-счете заказа и освобождаются по мере выполнения вех.

### Групповые заказы

Особенность библиотеки - поддержка групповых заказов, которые позволяют:
- Объединять нескольких заказчиков в одном проекте
- Управлять индивидуальными взносами участников
- Выбирать представителя группы через голосование
- Распределять финансирование между участниками
- Контролировать баланс эскроу-счета
- Менять состав участников при необходимости

Каждый заказчик имеет свою долю в заказе и может голосовать за представителя группы, который уполномочен принимать решения от имени всех участников.

### Акты приемки

По завершении вехи исполнитель формирует акт выполненных работ:
- Акт создается на основе завершенных задач и результатов работ
- Подписывается исполнителем и заказчиком (или представителем группы заказчиков)
- После подписания акта средства автоматически переводятся исполнителю
- История актов сохраняется для отчетности и аудита

### Документооборот и AI

Библиотека предоставляет интеграцию с Google Gemini AI для автоматизации документооборота:
- **Автоматическая генерация документов**:
  - Definition of Ready (DoR) - определяет критерии готовности к началу работ
  - Roadmap - формирует детальный план проекта с фазами и задачами
  - Definition of Done (DoD) - устанавливает критерии приемки результатов
  - Спецификации - детальные технические описания требований
- **Валидация результатов работы**:
  - Автоматическая проверка соответствия поставленным критериям
  - Анализ выполненных задач на соответствие DoD
  - Предоставление рекомендаций по исправлению недочетов
- **Интеллектуальный анализ**:
  - Оценка соответствия выполненных задач первоначальным требованиям
  - Выявление рисков и потенциальных проблем
  - Предложения по оптимизации процессов

Модуль AI интегрируется с существующими процессами документооборота и позволяет значительно сократить время на рутинные задачи, обеспечивая при этом более высокое качество документации и валидации результатов.

### Коммуникация

Встроенная система обсуждений и сообщений позволяет всем участникам проекта взаимодействовать в рамках заказа:
- Создание тематических обсуждений по различным аспектам проекта
- Обмен личными и групповыми сообщениями
- Комментирование задач, документов и результатов работ
- Уведомления о важных событиях и изменениях
- История коммуникаций для полного понимания контекста

### События

Система событий и подписок позволяет реагировать на различные изменения в проекте:
- События создания и изменения заказов
- События финансирования и выплат
- События по вехам и задачам
- События документооборота
- События коммуникаций и голосований

Подписка на события позволяет создавать интерактивные приложения и настраивать автоматизированные рабочие процессы.

Пример использования событий:
```typescript
// Подписка на события создания заказа
escrowManager.on('order:created', (order) => {
  console.log(`Создан новый заказ: ${order.title}`);
});

// Подписка на события финансирования заказа
escrowManager.on('order:funded', (order) => {
  console.log(`Заказ полностью профинансирован: ${order.id}`);
});

// Подписка на завершение вех
escrowManager.on('milestone:completed', ({ orderId, milestoneId }) => {
  console.log(`Веха ${milestoneId} заказа ${orderId} отмечена как завершенная`);
});

// Подписка на события документооборота
escrowManager.on('document:generated', ({ documentId, type }) => {
  console.log(`Создан новый документ типа ${type}: ${documentId}`);
});

// Подписка на результаты валидации
escrowManager.on('validation:completed', ({ orderId, result }) => {
  console.log(`Валидация для заказа ${orderId} завершена с результатом: ${result.compliant ? 'успешно' : 'требуются доработки'}`);
});
```

## Архитектура

Библиотека имеет модульную архитектуру:

- **Models**: базовые сущности (User, Order, Milestone, Act, Document, Message)
- **Services**: логика работы с сущностями (UserService, OrderService, AIService, DocumentService и т.д.)
- **Interfaces**: определения типов и интерфейсов
- **Utils**: вспомогательные функции и константы
- **Events**: система событий и подписок

Модульная архитектура обеспечивает:
- Высокую гибкость и расширяемость
- Возможность использования только необходимых компонентов
- Легкость поддержки и тестирования
- Чистое разделение ответственности между модулями 