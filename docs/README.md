# Escrow Library

Библиотека для управления эскроу-счетами и групповыми заказами. Позволяет создавать и управлять групповыми заказами, с возможностью вступления участников, голосования и смены представителя заказчика квалифицированным большинством, сбора средств на балансы участников и эскроу-счета, оформления документов (DoR, DoD и дорожных карт), оформления актов, коммуникации между участниками и выплат на балансы исполнителей.

## Установка

```bash
npm install escrow-lib
```

## Основные возможности

- **Управление пользователями**: создание и управление заказчиками и исполнителями
- **Управление заказами**: создание, финансирование и выполнение заказов
- **Групповые заказы**: возможность объединения нескольких заказчиков
- **Вехи (milestones)**: разделение заказа на этапы с отдельными выплатами
- **Эскроу-счета**: безопасное хранение средств до выполнения условий
- **Акты**: подтверждение выполнения работ с подписями сторон
- **Голосование**: смена представителя квалифицированным большинством
- **Документы**: создание и согласование DoR, DoD и дорожных карт
- **Коммуникация**: обсуждения и обмен сообщениями между участниками

## Основные концепции

### Пользователи

В системе существует три типа пользователей:
- **Заказчик (Customer)**: может создавать заказы, вносить средства и голосовать
- **Исполнитель (Contractor)**: выполняет работы по заказам и получает оплату
- **Платформа (Platform)**: системная роль для административных функций

### Заказы

Заказ представляет собой договор между заказчиками и исполнителем. Каждый заказ имеет:
- Описание работ
- Набор вех (milestone)
- Эскроу-счет для хранения средств
- Представителя заказчиков
- Документы (DoR, DoD, roadmap)
- Дискуссии для коммуникации

### Вехи и акты

Каждая веха представляет собой часть работы, которая должна быть выполнена. После завершения вехи:
1. Исполнитель отмечает веху как выполненную
2. Создается акт выполненных работ
3. Участники (исполнитель, представитель заказчиков, платформа) подписывают акт
4. После необходимого количества подписей средства переводятся на баланс исполнителя

### Голосование

Участники заказа могут инициировать голосование за нового представителя. Если кандидат набирает голоса, представляющие 75% от стоимости заказа, он становится новым представителем.

### Коммуникация

Участники могут создавать дискуссии и обмениваться сообщениями в рамках заказа для обсуждения деталей, согласования изменений и решения вопросов.

## Использование

```typescript
import EscrowManager, { UserType, DocumentType } from 'escrow-lib';

// Создание менеджера эскроу
const escrow = new EscrowManager();

// Пример основного потока работы
async function workflowExample() {
  // Создание пользователей
  const customer = await escrow.createUser('Заказчик', UserType.CUSTOMER);
  const contractor = await escrow.createUser('Исполнитель', UserType.CONTRACTOR);
  
  // Пополнение баланса заказчика
  await escrow.deposit(customer.id, '1000');
  
  // Создание заказа с вехами
  const order = await escrow.createOrder(
    customer.id,
    'Название заказа',
    'Описание заказа',
    [
      { description: 'Первая веха', amount: '400' },
      { description: 'Вторая веха', amount: '600' }
    ]
  );
  
  // Финансирование заказа
  await escrow.contributeFunds(order.id, customer.id, '1000');
  
  // Назначение исполнителя
  await escrow.assignContractor(order.id, contractor.id);
  
  // Создание документа "Определение готовности"
  const dor = await escrow.createDocument(
    order.id,
    DocumentType.DEFINITION_OF_READY,
    'Содержание документа "Определение готовности"',
    customer.id
  );
  
  // Исполнитель утверждает документ
  await escrow.approveDocument(dor.id, contractor.id);
  
  // Создание обсуждения
  const discussion = await escrow.createDiscussion(
    order.id,
    'Обсуждение заказа',
    contractor.id
  );
  
  // Обмен сообщениями
  await escrow.sendMessage(
    discussion.id,
    contractor.id,
    'Начинаю работу над заказом'
  );
  
  // Отметка первой вехи как выполненной
  const act = await escrow.markMilestoneComplete(
    order.id,
    order.milestones[0].id,
    contractor.id
  );
  
  // Подписание акта сторонами
  await escrow.signAct(act.id, contractor.id);
  await escrow.signAct(act.id, customer.id);
  
  // Проверка баланса исполнителя после выплаты
  const updatedContractor = await escrow.getUser(contractor.id);
  console.log(`Баланс исполнителя: ${updatedContractor.balance}`);
}
```

## События

Библиотека использует систему событий для отслеживания изменений:

```typescript
import { EscrowEvents } from 'escrow-lib';

// Подписка на события
escrow.on(EscrowEvents.ORDER_CREATED, (order) => {
  console.log(`Создан новый заказ: ${order.title}`);
});

escrow.on(EscrowEvents.MILESTONE_COMPLETED, ({ orderId, milestoneId }) => {
  console.log(`Веха ${milestoneId} заказа ${orderId} выполнена`);
});

// Одноразовая подписка
escrow.once(EscrowEvents.ACT_COMPLETED, ({ actId }) => {
  console.log(`Акт ${actId} полностью подписан`);
});
```

## Расширенное использование

См. другие документы в этой папке для подробных инструкций по отдельным функциям:

- [Управление пользователями](./users.md)
- [Управление заказами](./orders.md)
- [Вехи и акты](./milestones.md)
- [Голосование](./voting.md)
- [Документы](./documents.md)
- [Коммуникация](./communication.md) 